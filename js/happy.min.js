(function(a){function b(b){return"".trim?b.val().trim():a.trim(b.val())}a.fn.isHappy=function(c){function f(b){return a('<span id="'+b.id+'" class="unhappyMessage">'+b.message+"</span>")}function g(){var a=false,b,e;for(b=0,e=d.length;b<e;b+=1){if(!d[b].testValid(true)){a=true}}if(a){if(h(c.unHappy))c.unHappy();return false}else if(c.testMode){if(window.console)console.warn("would have submitted");return false}}function h(a){return!!(a&&a.constructor&&a.call&&a.apply)}function i(e,g){var i=a(g),j={message:e.message,id:g.slice(1)+"_unhappy"},k=a(j.id).length>0?a(j.id):f(j);d.push(i);i.testValid=function(c){var d,f=a(this),g,j=false,l,m=!!f.get(0).attributes.getNamedItem("required")||e.required,n=i.attr("type")==="password",o=h(e.arg)?e.arg():e.arg;if(h(e.clean)){d=e.clean(f.val())}else if(!e.trim&&!n){d=b(f)}else{d=f.val()}f.val(d);g=(d.length>0||m==="sometimes")&&h(e.test);if(c===true&&m===true&&d.length===0){j=true}else if(g){j=!e.test(d,o)}if(j){f.addClass("unhappy").before(k);return false}else{l=k.get(0);if(l.parentNode){l.parentNode.removeChild(l)}f.removeClass("unhappy");return true}};i.bind(c.when||"blur",i.testValid)}var d=[],e;for(e in c.fields){i(c.fields[e],e)}if(c.submitButton){a(c.submitButton).click(g)}else{this.bind("submit",g)}return this}})(this.jQuery||this.Zepto)